# HÆ°á»›ng dáº«n sá»­ dá»¥ng Module Nghá»‰ phÃ©p & LÆ°Æ¡ng

## ğŸ“… Module Nghá»‰ phÃ©p (Leave Management)

### 1. Truy cáº­p Menu
Sau khi login, báº¡n sáº½ tháº¥y menu **"Nghá»‰ phÃ©p"** trong sidebar bÃªn trÃ¡i vá»›i 2 má»¥c:
- **ÄÆ¡n nghá»‰ phÃ©p**: Quáº£n lÃ½ Ä‘Æ¡n nghá»‰ phÃ©p cá»§a báº¡n
- **PhÃª duyá»‡t**: Xem Ä‘Æ¡n chá» duyá»‡t (dÃ nh cho Manager/HR)

---

### 2. Táº¡o Ä‘Æ¡n nghá»‰ phÃ©p má»›i

#### BÆ°á»›c 1: VÃ o trang ÄÆ¡n nghá»‰ phÃ©p
- Click **"Nghá»‰ phÃ©p" â†’ "ÄÆ¡n nghá»‰ phÃ©p"** trong menu
- Click nÃºt **"Táº¡o Ä‘Æ¡n má»›i"** (mÃ u xanh, gÃ³c trÃªn bÃªn trÃ¡i)

#### BÆ°á»›c 2: Äiá»n thÃ´ng tin
1. **Loáº¡i phÃ©p**: Chá»n tá»« dropdown
   - PhÃ©p nÄƒm (12 ngÃ y/nÄƒm, cÃ³ lÆ°Æ¡ng)
   - PhÃ©p á»‘m (30 ngÃ y/nÄƒm, cÃ³ lÆ°Æ¡ng)
   - PhÃ©p riÃªng cÃ³ lÆ°Æ¡ng (3 ngÃ y/nÄƒm)
   - PhÃ©p khÃ´ng lÆ°Æ¡ng
   - PhÃ©p thai sáº£n (180 ngÃ y)
   - PhÃ©p há»c táº­p, PhÃ©p cÃ´ng tÃ¡c

2. **Sá»‘ ngÃ y phÃ©p cÃ²n láº¡i**: Hiá»ƒn thá»‹ tá»± Ä‘á»™ng sau khi chá»n loáº¡i phÃ©p

3. **Tá»« ngÃ y**: Chá»n ngÃ y báº¯t Ä‘áº§u nghá»‰

4. **Äáº¿n ngÃ y**: Chá»n ngÃ y káº¿t thÃºc nghá»‰ (pháº£i >= ngÃ y báº¯t Ä‘áº§u)

5. **Sá»‘ ngÃ y nghá»‰**: Tá»± Ä‘á»™ng tÃ­nh (khÃ´ng tÃ­nh thá»© 7, CN)
   - âš ï¸ Cáº£nh bÃ¡o mÃ u Ä‘á» náº¿u vÆ°á»£t sá»‘ ngÃ y phÃ©p cÃ²n láº¡i

6. **LÃ½ do nghá»‰**: Nháº­p lÃ½ do (khÃ´ng báº¯t buá»™c)

#### BÆ°á»›c 3: LÆ°u hoáº·c Ná»™p Ä‘Æ¡n
- **LÆ°u nhÃ¡p**: LÆ°u Ä‘Æ¡n Ä‘á»ƒ chá»‰nh sá»­a sau
- **Ná»™p Ä‘Æ¡n**: Gá»­i ngay vÃ o quy trÃ¬nh phÃª duyá»‡t
  - âœ… Há»‡ thá»‘ng tá»± Ä‘á»™ng kiá»ƒm tra sá»‘ ngÃ y phÃ©p
  - âœ… Táº¡o chuá»—i phÃª duyá»‡t 3 bÆ°á»›c:
    1. TrÆ°á»Ÿng phÃ²ng (LINE_MANAGER)
    2. GiÃ¡m Ä‘á»‘c (DIRECTOR) - náº¿u cÃ³ phÃ²ng cáº¥p trÃªn
    3. PhÃ²ng NhÃ¢n sá»± (HR)

---

### 3. Quáº£n lÃ½ Ä‘Æ¡n nghá»‰ phÃ©p

#### Xem danh sÃ¡ch Ä‘Æ¡n
Trang **"ÄÆ¡n nghá»‰ phÃ©p"** hiá»ƒn thá»‹ táº¥t cáº£ Ä‘Æ¡n cá»§a báº¡n vá»›i cÃ¡c cá»™t:
- MÃ£ NV
- Loáº¡i phÃ©p (badge mÃ u)
- Tá»« ngÃ y â†’ Äáº¿n ngÃ y
- Sá»‘ ngÃ y
- Tráº¡ng thÃ¡i (badge mÃ u):
  - ğŸ”µ **NhÃ¡p**: ChÆ°a ná»™p, cÃ³ thá»ƒ sá»­a
  - ğŸŸ¡ **Chá» duyá»‡t**: Äang trong quy trÃ¬nh
  - ğŸŸ¢ **ÄÃ£ duyá»‡t**: HoÃ n táº¥t
  - ğŸ”´ **Tá»« chá»‘i**: Bá»‹ tá»« chá»‘i
  - ğŸŸ  **ÄÃ£ há»§y**: ÄÃ£ há»§y bá»Ÿi báº¡n
- NgÃ y ná»™p

#### Bá»™ lá»c
- **Loáº¡i phÃ©p**: Lá»c theo loáº¡i
- **Tráº¡ng thÃ¡i**: Lá»c theo tráº¡ng thÃ¡i
- **Tá»« ngÃ y/Äáº¿n ngÃ y**: Lá»c theo khoáº£ng thá»i gian
- **TÃ¬m kiáº¿m**: TÃ¬m theo tÃªn NV hoáº·c lÃ½ do

#### Thao tÃ¡c trÃªn Ä‘Æ¡n
1. **ğŸ‘ï¸ Xem chi tiáº¿t**: Click icon máº¯t
   - Xem timeline phÃª duyá»‡t
   - Xem comment cá»§a ngÆ°á»i duyá»‡t
   - Xem thá»i gian tá»«ng bÆ°á»›c

2. **âœï¸ Chá»‰nh sá»­a**: Chá»‰ vá»›i Ä‘Æ¡n NHÃP
   - Sá»­a thÃ´ng tin vÃ  lÆ°u láº¡i
   - Hoáº·c sá»­a xong vÃ  ná»™p luÃ´n

3. **ğŸ—‘ï¸ XÃ³a**: Chá»‰ vá»›i Ä‘Æ¡n NHÃP hoáº·c ÄÃƒ Há»¦Y

---

### 4. Xem chi tiáº¿t Ä‘Æ¡n nghá»‰ phÃ©p

Khi click vÃ o icon ğŸ‘ï¸, báº¡n sáº½ tháº¥y:

#### Panel bÃªn trÃ¡i: ThÃ´ng tin chÃ­nh
- ThÃ´ng tin nhÃ¢n viÃªn
- Loáº¡i phÃ©p (badge mÃ u + nhÃ£n "CÃ³ lÆ°Æ¡ng")
- Tá»« ngÃ y â†’ Äáº¿n ngÃ y
- Sá»‘ ngÃ y nghá»‰ (sá»‘ lá»›n mÃ u xanh)
- Sá»‘ ngÃ y phÃ©p cÃ²n láº¡i
- LÃ½ do nghá»‰

#### Timeline phÃª duyá»‡t
Hiá»ƒn thá»‹ cÃ¡c bÆ°á»›c phÃª duyá»‡t theo thá»© tá»±:
- â³ **Chá» duyá»‡t**: Icon xÃ¡m
- âœ… **ÄÃ£ duyá»‡t**: Icon xanh + thá»i gian + comment
- âŒ **Tá»« chá»‘i**: Icon Ä‘á» + thá»i gian + lÃ½ do

VÃ­ dá»¥:
```
âœ… BÆ°á»›c 1 - TrÆ°á»Ÿng phÃ²ng
   Nguyá»…n VÄƒn A
   ÄÃ£ duyá»‡t
   ğŸ’¬ "Äá»“ng Ã½ cho nghá»‰"
   âœ… 04/12/2025 10:30

â³ BÆ°á»›c 2 - GiÃ¡m Ä‘á»‘c
   Tráº§n VÄƒn B
   Chá» duyá»‡t

â³ BÆ°á»›c 3 - PhÃ²ng NhÃ¢n sá»±
   HR Head
   Chá» duyá»‡t
```

#### Panel bÃªn pháº£i: Thá»i gian & Thao tÃ¡c
**Thá»i gian:**
- Táº¡o lÃºc
- Ná»™p Ä‘Æ¡n
- Duyá»‡t cuá»‘i / Tá»« chá»‘i / Há»§y bá»

**Thao tÃ¡c:**
- âœï¸ Chá»‰nh sá»­a (náº¿u NHÃP)
- ğŸ“¤ Ná»™p Ä‘Æ¡n (náº¿u NHÃP)
- âœ… PhÃª duyá»‡t (náº¿u báº¡n lÃ  ngÆ°á»i duyá»‡t tiáº¿p theo)
- âŒ Tá»« chá»‘i (náº¿u báº¡n lÃ  ngÆ°á»i duyá»‡t)
- ğŸš« Há»§y Ä‘Æ¡n (náº¿u NHÃP hoáº·c CHá»œ DUYá»†T)
- â¬…ï¸ Quay láº¡i

---

### 5. PhÃª duyá»‡t Ä‘Æ¡n nghá»‰ phÃ©p (DÃ nh cho Manager/HR)

#### Truy cáº­p trang PhÃª duyá»‡t
- Click **"Nghá»‰ phÃ©p" â†’ "PhÃª duyá»‡t"**
- Badge sá»‘ Ä‘áº¿m hiá»ƒn thá»‹ sá»‘ Ä‘Æ¡n chá» báº¡n duyá»‡t

#### Danh sÃ¡ch Ä‘Æ¡n chá» duyá»‡t
Hiá»ƒn thá»‹ cÃ¡c Ä‘Æ¡n mÃ  **báº¡n lÃ  ngÆ°á»i duyá»‡t tiáº¿p theo**:
- ThÃ´ng tin nhÃ¢n viÃªn
- Loáº¡i phÃ©p
- Tá»« ngÃ y â†’ Äáº¿n ngÃ y
- Sá»‘ ngÃ y
- NgÃ y ná»™p
- **BÆ°á»›c duyá»‡t**: Hiá»ƒn thá»‹ bÆ°á»›c hiá»‡n táº¡i + vai trÃ² cá»§a báº¡n
  - "BÆ°á»›c 1 - TrÆ°á»Ÿng phÃ²ng"
  - "BÆ°á»›c 2 - GiÃ¡m Ä‘á»‘c"
  - "BÆ°á»›c 3 - PhÃ²ng NhÃ¢n sá»±"

#### PhÃª duyá»‡t/Tá»« chá»‘i nhanh
Tá»« danh sÃ¡ch, click:
1. **ğŸ‘ï¸ Xem chi tiáº¿t**: Xem Ä‘áº§y Ä‘á»§ thÃ´ng tin
2. **âœ… PhÃª duyá»‡t**: Má»Ÿ dialog phÃª duyá»‡t
3. **âŒ Tá»« chá»‘i**: Má»Ÿ dialog tá»« chá»‘i

#### Dialog PhÃª duyá»‡t
1. Xem láº¡i thÃ´ng tin Ä‘Æ¡n
2. Nháº­p nháº­n xÃ©t (khÃ´ng báº¯t buá»™c)
3. Click **"PhÃª duyá»‡t"**
   - âœ… Chuyá»ƒn sang bÆ°á»›c tiáº¿p theo
   - âœ… Náº¿u lÃ  bÆ°á»›c cuá»‘i â†’ Ä‘Æ¡n APPROVED + trá»« sá»‘ ngÃ y phÃ©p

#### Dialog Tá»« chá»‘i
1. Xem láº¡i thÃ´ng tin Ä‘Æ¡n
2. **Nháº­p lÃ½ do tá»« chá»‘i** (Báº®T BUá»˜C)
3. Click **"Tá»« chá»‘i"**
   - âŒ ÄÆ¡n chuyá»ƒn sang REJECTED
   - âŒ KhÃ´ng trá»« sá»‘ ngÃ y phÃ©p

---

### 6. Quy trÃ¬nh phÃª duyá»‡t tá»± Ä‘á»™ng

Khi báº¡n ná»™p Ä‘Æ¡n, há»‡ thá»‘ng tá»± Ä‘á»™ng:

1. **TÃ¬m TrÆ°á»Ÿng phÃ²ng** (BÆ°á»›c 1)
   - Láº¥y tá»« phÃ¢n cÃ´ng PRIMARY cá»§a báº¡n
   - TÃ¬m ngÆ°á»i cÃ³ role_type = HEAD trong cÃ¹ng phÃ²ng
   - KhÃ´ng tá»± phÃª duyá»‡t cho chÃ­nh mÃ¬nh

2. **TÃ¬m GiÃ¡m Ä‘á»‘c** (BÆ°á»›c 2) - náº¿u cÃ³
   - Náº¿u phÃ²ng cá»§a báº¡n cÃ³ phÃ²ng cáº¥p trÃªn (parent_department)
   - TÃ¬m HEAD cá»§a phÃ²ng cáº¥p trÃªn

3. **PhÃ²ng NhÃ¢n sá»±** (BÆ°á»›c 3)
   - Tá»± Ä‘á»™ng tÃ¬m user cÃ³ role "HR Head"

4. **PhÃª duyá»‡t tuáº§n tá»±**
   - Pháº£i duyá»‡t theo thá»© tá»±: BÆ°á»›c 1 â†’ 2 â†’ 3
   - KhÃ´ng thá»ƒ skip bÆ°á»›c

5. **Auto-approve**
   - Náº¿u loáº¡i phÃ©p khÃ´ng cáº§n phÃª duyá»‡t (requires_approval = false)
   - Tá»± Ä‘á»™ng APPROVED vÃ  trá»« sá»‘ ngÃ y phÃ©p

---

## ğŸ’° Module LÆ°Æ¡ng (Payroll)

### 1. Cáº¥u trÃºc Module

#### 3 báº£ng chÃ­nh:
1. **Ká»³ lÆ°Æ¡ng (Payroll Periods)**
   - Quáº£n lÃ½ theo thÃ¡ng/nÄƒm
   - Status: DRAFT â†’ PROCESSING â†’ APPROVED â†’ PAID

2. **Báº£ng lÆ°Æ¡ng (Payroll Items)**
   - Chi tiáº¿t lÆ°Æ¡ng tá»«ng nhÃ¢n viÃªn
   - LÆ°u snapshot: phÃ²ng ban, chá»©c vá»¥, role

3. **Äiá»u chá»‰nh (Adjustments)**
   - ThÆ°á»Ÿng, pháº¡t, táº¡m á»©ng, lÃ m thÃªm giá»

---

### 2. TÃ­nh lÆ°Æ¡ng tá»± Ä‘á»™ng

#### PayrollCalculationService thá»±c hiá»‡n:

**BÆ°á»›c 1: Láº¥y thÃ´ng tin cÆ¡ báº£n**
- Contract hiá»‡n táº¡i â†’ **Base Salary**
- Assignment PRIMARY â†’ **Position Allowance**
  - HEAD: 2,000,000 VND
  - DEPUTY: 1,000,000 VND
  - MEMBER: 0 VND

**BÆ°á»›c 2: TÃ­nh Gross Salary**
```
Total Allowances = Position + Responsibility + Other
Gross Salary = (Base Salary + Total Allowances) Ã— (Working Days / 22)
```

VÃ­ dá»¥:
- Base: 15,000,000 VND
- Position (HEAD): 2,000,000 VND
- Working days: 20/22
- Gross = (15M + 2M) Ã— (20/22) = 15,454,545 VND

**BÆ°á»›c 3: Kháº¥u trá»« Báº£o hiá»ƒm**
- BHXH: 8% Ã— Gross = 1,236,364 VND
- BHYT: 1.5% Ã— Gross = 231,818 VND
- BHTN: 1% Ã— Gross = 154,545 VND
- **Tá»•ng Báº£o hiá»ƒm**: 1,622,727 VND

**BÆ°á»›c 4: TÃ­nh Thu nháº­p chá»‹u thuáº¿**
```
Taxable Income = Gross - Insurance - Personal Deduction - Dependent Deduction
```
- Personal Deduction: 11,000,000 VND (báº£n thÃ¢n)
- Dependent Deduction: 4,400,000 VND Ã— sá»‘ ngÆ°á»i phá»¥ thuá»™c

VÃ­ dá»¥ (0 ngÆ°á»i phá»¥ thuá»™c):
```
Taxable = 15,454,545 - 1,622,727 - 11,000,000 - 0 = 2,831,818 VND
```

**BÆ°á»›c 5: Thuáº¿ TNCN (7 báº­c lÅ©y tiáº¿n)**
| Thu nháº­p chá»‹u thuáº¿ | Thuáº¿ suáº¥t |
|-------------------|-----------|
| 0 - 5M            | 5%        |
| 5M - 10M          | 10%       |
| 10M - 18M         | 15%       |
| 18M - 32M         | 20%       |
| 32M - 52M         | 25%       |
| 52M - 80M         | 30%       |
| TrÃªn 80M          | 35%       |

VÃ­ dá»¥ vá»›i 2,831,818 VND:
```
Tax = 2,831,818 Ã— 5% = 141,591 VND
```

**BÆ°á»›c 6: TÃ­nh LÆ°Æ¡ng thá»±c lÄ©nh**
```
Net Salary = Gross Salary - Total Deductions
Total Deductions = Insurance + Income Tax + Other Deductions
```

VÃ­ dá»¥:
```
Net = 15,454,545 - (1,622,727 + 141,591) = 13,690,227 VND
```

---

### 3. Snapshot Pattern

Há»‡ thá»‘ng lÆ°u **snapshot** cá»§a thÃ´ng tin táº¡i thá»i Ä‘iá»ƒm tÃ­nh lÆ°Æ¡ng:
- department_name: "PhÃ²ng IT"
- position_title: "TrÆ°á»Ÿng phÃ²ng"
- role_type: "HEAD"

âœ… Äáº£m báº£o dá»¯ liá»‡u lÆ°Æ¡ng khÃ´ng thay Ä‘á»•i khi:
- NhÃ¢n viÃªn chuyá»ƒn phÃ²ng
- Äá»•i chá»©c vá»¥
- Cáº­p nháº­t tÃªn phÃ²ng/chá»©c vá»¥

---

### 4. Calculation Details (JSON)

Má»—i payroll item lÆ°u chi tiáº¿t tÃ­nh toÃ¡n:
```json
{
  "contract_number": "HD-2025-001",
  "calculation_date": "2025-12-04 10:30:00",
  "base_salary_breakdown": {
    "monthly_base": 15000000,
    "position_allowance": 2000000,
    "role_type": "HEAD"
  },
  "attendance": {
    "working_days": 20,
    "standard_days": 22,
    "rate": 90.91
  },
  "deductions_breakdown": {
    "social_insurance": {"rate": "8%", "amount": 1236364},
    "health_insurance": {"rate": "1.5%", "amount": 231818},
    "unemployment_insurance": {"rate": "1%", "amount": 154545}
  },
  "tax_calculation": {
    "gross_salary": 15454545,
    "insurance_deduction": 1622727,
    "personal_deduction": 11000000,
    "dependent_deduction": 0,
    "dependents_count": 0,
    "taxable_income": 2831818,
    "income_tax": 141591
  }
}
```

---

### 5. Workflow (DÃ nh cho HR/Admin)

#### Táº¡o ká»³ lÆ°Æ¡ng má»›i
1. Táº¡o PayrollPeriod (thÃ¡ng/nÄƒm)
2. Status: DRAFT

#### TÃ­nh lÆ°Æ¡ng cho toÃ n bá»™ nhÃ¢n viÃªn
```php
$service = new PayrollCalculationService();
$results = $service->calculatePayrollForPeriod($period);
```

Káº¿t quáº£:
```php
[
  'success' => [employee_ids...],  // ThÃ nh cÃ´ng
  'failed' => [                     // Tháº¥t báº¡i
    ['employee_id' => 'xxx', 'error' => 'No active contract']
  ],
  'total' => 50
]
```

#### ThÃªm Ä‘iá»u chá»‰nh (Adjustment)
```php
PayrollAdjustment::create([
  'payroll_item_id' => $item->id,
  'type' => 'BONUS',           // BONUS/PENALTY/ADVANCE/OVERTIME/OTHER
  'amount' => 5000000,         // Sá»‘ tiá»n
  'reason' => 'ThÆ°á»Ÿng dá»± Ã¡n',
  'description' => 'HoÃ n thÃ nh dá»± Ã¡n X'
]);
```

#### PhÃª duyá»‡t vÃ  Thanh toÃ¡n
1. PROCESSING â†’ APPROVED (sau khi review)
2. APPROVED â†’ PAID (sau khi chuyá»ƒn lÆ°Æ¡ng)

---

### 6. API Endpoints (Äá»ƒ implement UI sau)

CÃ¡c route cáº§n cÃ³:
```php
// Payroll Periods
GET    /payroll-periods           // List ká»³ lÆ°Æ¡ng
POST   /payroll-periods           // Táº¡o ká»³ má»›i
GET    /payroll-periods/{id}      // Chi tiáº¿t ká»³
POST   /payroll-periods/{id}/calculate  // TÃ­nh lÆ°Æ¡ng toÃ n bá»™
POST   /payroll-periods/{id}/approve    // PhÃª duyá»‡t
POST   /payroll-periods/{id}/mark-paid  // ÄÃ¡nh dáº¥u Ä‘Ã£ tráº£

// Payroll Items
GET    /payroll-items             // List báº£ng lÆ°Æ¡ng
GET    /payroll-items/{id}        // Chi tiáº¿t 1 nhÃ¢n viÃªn
POST   /payroll-items/{id}/recalculate  // TÃ­nh láº¡i

// Adjustments
POST   /payroll-items/{id}/adjustments  // ThÃªm Ä‘iá»u chá»‰nh
DELETE /adjustments/{id}          // XÃ³a Ä‘iá»u chá»‰nh
```

---

## ğŸ¯ TÃ³m táº¯t cho User thÃ´ng thÆ°á»ng

### Nghá»‰ phÃ©p:
1. **Táº¡o Ä‘Æ¡n**: Menu â†’ Nghá»‰ phÃ©p â†’ ÄÆ¡n nghá»‰ phÃ©p â†’ Táº¡o Ä‘Æ¡n má»›i
2. **Äiá»n form**: Chá»n loáº¡i phÃ©p, tá»« ngÃ y, Ä‘áº¿n ngÃ y, lÃ½ do
3. **Ná»™p Ä‘Æ¡n**: Click "Ná»™p Ä‘Æ¡n" â†’ VÃ o quy trÃ¬nh phÃª duyá»‡t 3 bÆ°á»›c
4. **Theo dÃµi**: Xem tráº¡ng thÃ¡i vÃ  timeline phÃª duyá»‡t

### PhÃª duyá»‡t (Manager/HR):
1. **Kiá»ƒm tra**: Menu â†’ Nghá»‰ phÃ©p â†’ PhÃª duyá»‡t
2. **Badge**: Sá»‘ Ä‘Æ¡n chá» báº¡n duyá»‡t
3. **Xá»­ lÃ½**: Click âœ… PhÃª duyá»‡t hoáº·c âŒ Tá»« chá»‘i
4. **Comment**: Nháº­p nháº­n xÃ©t/lÃ½ do

### LÆ°Æ¡ng (HR/Admin):
- Module Ä‘Ã£ sáºµn sÃ ng vá»›i full business logic
- UI Ä‘á»ƒ implement sau
- TÃ­nh toÃ¡n tá»± Ä‘á»™ng: Contract + Assignment + Attendance â†’ Net Salary

---

## ğŸ“ Há»— trá»£

Náº¿u cÃ³ váº¥n Ä‘á»:
1. Kiá»ƒm tra phÃ¢n cÃ´ng PRIMARY (cáº§n cÃ³ Ä‘á»ƒ tÃ­nh phá»¥ cáº¥p vÃ  approval routing)
2. Kiá»ƒm tra Contract hiá»‡n táº¡i (cáº§n cÃ³ Ä‘á»ƒ tÃ­nh lÆ°Æ¡ng cÆ¡ báº£n)
3. Kiá»ƒm tra role "HR Head" (cáº§n cÃ³ Ä‘á»ƒ phÃª duyá»‡t cuá»‘i)
4. Xem Activity Logs Ä‘á»ƒ trace lá»—i

âœ… Leave Module: **Ready to use**
â³ Payroll Module: **Backend ready, UI pending**
